# Normalized configuration for Vocal Smart Splitter (v2.x)
# Focus: Pure vocal detection with BPM/MDD/VPP adaptation and weighted NMS

audio:
  sample_rate: 44100
  channels: 1
  format: wav
  quality: 320

pure_vocal_detection:
  enable: true
  # Base detection
  min_pause_duration: 0.5
  breath_duration_range: [0.1, 0.3]
  f0_weight: 0.30
  formant_weight: 0.25
  spectral_weight: 0.25
  duration_weight: 0.20

  # Relative energy valleys (robust defaults)
  enable_relative_energy_mode: true
  # 提高相对阈值以产生更充足且更“长”的能量谷候选，避免遗留超长段
  peak_relative_threshold_ratio: 0.26   # recommended 0.16–0.22
  rms_relative_threshold_ratio: 0.32    # recommended 0.20–0.26

  # BPM/MDD-driven adaptation of relative thresholds
  relative_threshold_adaptation:
    enable: true
    # 收窄自适应振幅，避免把阈值压得过低导致候选过少
    clamp_min: 0.85
    clamp_max: 1.15
    bpm:
      slow_multiplier: 1.08
      medium_multiplier: 1.00
      fast_multiplier: 0.92
    mdd:
      base: 1.0
      gain: 0.2

  # VPP (Vocal Pause Profile) adaptation — only within singing blocks; exclude interludes
  pause_stats_adaptation:
    enable: true
    delta_db: 3.0               # voice_active = floor_db + delta_db
    morph_close_ms: 150         # close then open (run-length morphology)
    morph_open_ms: 50
    sing_block_min_s: 2.0
    interlude_min_s: 4.0
    interlude_coverage_check:
      enable: false             # optional: only drop long rests if ±pad coverage < threshold
      pad_seconds: 2.0          # ±padding window for coverage measurement
      coverage_threshold: 0.10  # voice_active coverage threshold within padded window
    classify_thresholds:
      slow: { mpd: 0.60, p95: 1.20, rr: 0.35 }
      fast: { mpd: 0.25, pr: 18, rr: 0.15 }
    # 轻度倍率，配合收窄后的clamp，避免阈值过度起伏
    multipliers: { slow: 1.08, medium: 1.00, fast: 0.92 }
    clamp_min: 0.75
    clamp_max: 1.25

  # Candidate scoring and NMS preferences
  valley_scoring:
    # 强化“长谷优先”，保持安静度为次要因子
    w_len: 0.7
    w_quiet: 0.3
    w_flat: 0.1
    use_weighted_nms: true
    merge_close_ms: 300           # 合并更近的碎谷，提升候选质量
    max_raw_candidates: 1200      # 能量谷原始候选上限，防爆炸
    max_kept_after_nms: 200       # 适度上调，确保有足够一轮切点供选择

spectral_classifier:
  breath_threshold: 0.3
  pause_threshold: 0.7
  uncertain_range: [0.3, 0.7]
  f0_weight: 0.25
  formant_weight: 0.20
  spectral_weight: 0.20
  duration_weight: 0.20
  energy_weight: 0.15

musical_dynamic_density:
  enable: true
  energy_weight: 0.5
  spectral_weight: 0.3
  onset_weight: 0.2
  threshold_multiplier: 0.2
  max_multiplier: 1.4
  min_multiplier: 0.6
  chorus_detection:
    enable: true
    energy_threshold: 0.55
    density_threshold: 0.75
    multiplier: 1.1
  segment_analysis:
    window_overlap: 0.5
    smoothing_factor: 0.3
    min_segment_duration: 8.0

quality_control:
  validate_split_points: true
  # adaptive (may be overridden by BPM layer if present)
  min_pause_at_split: 1.0
  # 降低最小切点间隔，让一次检测能保留更多“足够分散”的切点
  min_split_gap: 1.0
  # static constraints
  min_vocal_content_ratio: 0.4
  max_silence_ratio: 0.3
  enable_zero_crossing_align: true
  fade_in_duration: 0.0
  fade_out_duration: 0.0
  normalize_audio: false
  remove_click_noise: false
  smooth_transitions: false
  # Length governance (V2 finalize)
  # 仅用于“合并短段”下限；上限不在终筛强制，建议作为目标范围调参
  segment_min_duration: 5.0
  segment_max_duration: 18.0
  # Pure-music splitting: min duration threshold (seconds). 0 = disabled (default).
  pure_music_min_duration: 6.0
  segment_vocal_threshold_db: -50.0
  # Segment classification voting thresholds (see SeamlessSplitter._classify_segments_vocal_presence)
  high_presence_ratio: 0.6 # 建议 0.6~0.7
  segment_vocal_overlap_ratio: 0.35
  segment_music_overlap_ratio: 0.55
  segment_vocal_energy_ratio: 0.6
  segment_music_energy_ratio: 0.4
  segment_noise_margin_db: 6.0
  segment_vocal_presence_ratio: 0.35
  segment_music_presence_ratio: 0.15

  # Quiet guard override (optional)
  enforce_quiet_cut:
    win_ms: 80
    # 略微放宽守卫余量并缩短右推距离，减少被推到边界导致的长段残留
    guard_db: 2.5
    search_right_ms: 150
    floor_percentile: 5

vocal_separation:
  hpss_margin: 2.0
  hpss_power: 1.5
  mask_threshold: 0.2
  mask_smoothing: 1
  vocal_freq_min: 100
  vocal_freq_max: 4000
  vocal_core_min: 200
  vocal_core_max: 1000
  min_vocal_ratio: 0.15
  max_noise_ratio: 0.3

output:
  directory: './output'
  naming_pattern: 'segment_{index:03d}'
  include_metadata: true
  save_debug_info: true
  save_separated_vocal: false
  save_breath_map: false
  save_analysis_report: true

logging:
  level: 'INFO'
  file: 'smart_splitter.log'
  format: '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
  max_file_size: '10MB'
  backup_count: 3

# 可选：BPM 自适应核心参数覆盖（若启用自适应层，以下覆盖将被使用）
bpm_adaptive_core:
  pause_duration_beats:
    slow: 1.5
    medium: 1.0
    fast: 0.6       # 快歌允许更短的“最小停顿”认定
    very_fast: 0.5
  split_gap_phrases:
    slow: 4
    medium: 3
    fast: 2         # 快歌降低分割间隙（按乐句/拍计算），避免遗留超长段
    very_fast: 2
  speech_pad_beats:
    slow: 0.8
    medium: 0.5
    fast: 0.3
    very_fast: 0.2
