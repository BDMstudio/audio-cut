# Hybrid MDD 设计方案对比

> **文档目的**：分析 `hybrid_mdd` 模式中 `_lib` 片段的切点生成策略，提供三种设计方案供选择。

## 背景

`hybrid_mdd` 模式的目标是在 MDD 人声停顿分割的基础上，为高能量段落（副歌）添加节拍卡点，使输出的片段具有"卡点感"（节拍对齐）。

**核心问题**：如何确定 `_lib` 片段的起点和终点？

---

## 方案对比

| 方案 | 起点 | 终点 | 时长特征 | 优点 | 缺点 |
|-----|-----|-----|---------|-----|-----|
| A | MDD 切点 | 小节边界 | 不固定 | 保留人声自然停顿 | 时长不规则 |
| B | 小节边界 | 小节边界 | 固定（N×小节时长） | 完全节拍对齐 | 可能切断人声 |
| C | MDD 切点吸附到节拍 | 小节边界 | 近似固定 | 兼顾两者 | 实现复杂 |

---

## 方案 A：当前实现（MDD 起点 + 节拍终点）

```
MDD切点          小节边界           小节边界
   ↓                ↓                  ↓
───┼────────────────┼──────────────────┼───
   │    _lib 片段   │                  │
   │←── 不固定 ────→│                  │
```

### 特点
- **起点**：MDD 检测到的人声停顿位置
- **终点**：librosa 检测到的小节边界
- **时长**：`小节边界 - MDD切点`，取决于二者距离

### 配置（unified.yaml）
```yaml
hybrid_mdd:
  beat_cut_density: medium  # low/medium/high
  # 当前默认行为
```

### 示例输出
```
segment_012_human_lib_3.7.wav  # 非固定时长
segment_014_human_lib_2.4.wav
segment_016_human_lib_2.5.wav
```

---

## 方案 B：纯节拍分割（节拍起点 + 节拍终点）

```
小节边界         小节边界           小节边界
   ↓                ↓                  ↓
───┼────────────────┼──────────────────┼───
   │    _lib 片段   │    _lib 片段     │
   │←── 2.5s ──────→│←── 2.5s ────────→│
```

### 特点
- **起点**：小节边界（忽略 MDD）
- **终点**：小节边界
- **时长**：固定为 `bars_per_cut × 小节时长`

### 配置建议
```yaml
hybrid_mdd:
  lib_alignment: beat_only  # 纯节拍对齐
  bars_per_cut: 1           # 每小节一个切点
```

### 示例输出
```
segment_012_human_lib_2.5.wav  # 固定时长 = 1 小节
segment_013_human_lib_2.5.wav
segment_014_human_lib_2.5.wav
```

### 潜在问题
在人声中间切断可能导致：
- 歌词被截断
- 听感不自然

---

## 方案 C：MDD 吸附到节拍（推荐）

```
MDD切点 (原始)    吸附后位置      小节边界
      ↓              ↓              ↓
──────●──────────────┼──────────────┼───
      └──吸附到最近节拍──→│    _lib    │
                          │←─ 固定 ─→│
```

### 算法
1. 获取 MDD 切点位置
2. 找到最近的节拍（前后 ±1 拍范围内）
3. 将 MDD 切点吸附到该节拍
4. 如果吸附后会切断人声（VAD 检测），则保留原 MDD 位置

### 特点
- **起点**：MDD 切点吸附到最近节拍（如果安全）
- **终点**：小节边界
- **时长**：接近固定，大多数情况下是节拍的整数倍

### 配置建议
```yaml
hybrid_mdd:
  lib_alignment: snap_to_beat  # 吸附模式
  snap_tolerance_ms: 300       # 吸附容差（ms）
  vad_protection: true         # 启用 VAD 保护
```

### 示例输出
```
segment_012_human_lib_2.5.wav  # 大多数固定
segment_014_human_lib_2.5.wav
segment_016_human_lib_5.0.wav  # 偶尔 2 小节（因 VAD 保护）
```

---

## 实现建议

### 选择方案的考量因素

| 考量点 | 方案 A | 方案 B | 方案 C |
|-------|-------|-------|-------|
| 实现复杂度 | ✓ 低（当前） | ✓ 低 | 中 |
| 节拍对齐程度 | 终点对齐 | 完全对齐 | 高度对齐 |
| 人声保护 | ✓ 完全保护 | 无 | ✓ 有保护 |
| 时长规则性 | 不规则 | ✓ 完全规则 | 近似规则 |

### 推荐

对于 MV 剪辑场景，**方案 C** 是最佳平衡：
- 既保证了"卡点感"（节拍对齐）
- 又不会在人声中间生硬切断
- 时长接近规则，便于后期编辑

---

## 下一步

1. 确定采用哪种方案
2. 在 `unified.yaml` 中添加 `lib_alignment` 配置项
3. 实现相应的吸附/对齐逻辑
4. 添加单元测试验证时长规则性
